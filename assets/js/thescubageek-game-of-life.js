"use strict";!function(){var t=new Stats;t.setMode(0),$(t.domElement).css({position:"absolute",right:"0px",bottom:"0px",zIndex:"-999999"}),$(document).ready(function(){$("body").append(t.domElement)});var e={columns:0,rows:0,waitTime:0,generation:0,running:!1,autoplay:!1,clear:{schedule:!1},times:{algorithm:0,gui:0},element:{generation:null,steptime:null,livecells:null,hint:null,messages:{layout:null}},initialState:'[{"39":[110]},{"40":[112]},{"41":[109,110,113,114,115]}]',trail:{current:!0,schedule:!1},zoom:{current:0,schedule:!1,schemes:[{columns:180,rows:86,cellSize:4},{columns:300,rows:144,cellSize:2},{columns:450,rows:216,cellSize:1}]},init:function(){this.listLife.init(),this.loadConfig(),this.loadState(),this.keepDOMElements(),this.canvas.init(),this.registerEvents(),this.prepare()},loadConfig:function(){var t;this.autoplay="1"===this.helpers.getUrlParameter("autoplay")||this.autoplay,this.trail.current="1"===this.helpers.getUrlParameter("trail")||this.trail.current,t=parseInt(this.helpers.getUrlParameter("zoom"),10),(isNaN(t)||t<1||t>e.zoom.schemes.length)&&(t=1),this.zoom.current=t-1,this.rows=this.zoom.schemes[this.zoom.current].rows,this.columns=this.zoom.schemes[this.zoom.current].columns},loadState:function(){var t,e,i,l,n=this.helpers.getUrlParameter("s");if("random"===n)this.randomState();else for(void 0==n&&(n=this.initialState),t=jsonParse(decodeURI(n)),e=0;e<t.length;e++)for(l in t[e])for(i=0;i<t[e][l].length;i++)this.listLife.addCell(t[e][l][i],parseInt(l,10),this.randomColor(),this.listLife.actualState)},randomState:function(){var t,e=this.rows*this.columns*.12;for(t=0;t<e;t++)this.listLife.addCell(this.helpers.random(0,this.columns-1),this.helpers.random(0,this.rows-1),this.randomColor(),this.listLife.actualState);this.listLife.nextGeneration()},randomColor:function(){for(var t="0123456789ABCDEF",e="#",i=0;i<6;i++)e+=t[Math.floor(16*Math.random())];return e},cleanUp:function(){this.listLife.init(),this.prepare()},prepare:function(){this.generation=this.times.algorithm=this.times.gui=0,this.mouseDown=this.clear.schedule=!1,this.element.generation.html("0"),this.element.livecells.html("0"),this.element.steptime.html("0 / 0 (0 / 0)"),this.canvas.clearWorld(),this.canvas.drawWorld(),this.autoplay&&(this.autoplay=!1,this.handlers.buttons.run())},keepDOMElements:function(){this.element.generation=$("#generation"),this.element.steptime=$("#steptime"),this.element.livecells=$("#livecells"),this.element.messages.layout=$("#layoutMessages"),this.element.hint=$("#hint")},registerEvents:function(){$("body").on("keyup",this.handlers.keyboard),$("#buttonRun").on("click",this.handlers.buttons.run),$("#buttonStep").on("click",this.handlers.buttons.step),$("#buttonClear").on("click",this.handlers.buttons.clear),$("#buttonExport").on("click",this.handlers.buttons.export_),$("#buttonTrail").on("click",this.handlers.buttons.trail)},nextStep:function(){var i,l,n,s,a,o,r,h;for(r=new Date,o=e.listLife.nextGeneration(),r=new Date-r,h=new Date,i=0;i<e.listLife.redrawList.length;i++)l=e.listLife.redrawList[i][0],n=e.listLife.redrawList[i][1],s=e.listLife.redrawList[i][2],1===e.listLife.redrawList[i][2]?e.canvas.changeCelltoAlive(l,n,s):2===e.listLife.redrawList[i][2]?e.canvas.keepCellAlive(l,n,s):e.canvas.changeCelltoDead(l,n,s);h=new Date-h,e.trail.schedule&&(e.trail.schedule=!1,e.canvas.drawWorld()),e.generation++,e.element.generation.innerHTML=e.generation,e.element.livecells.innerHTML=o,a=1/e.generation,e.times.algorithm=e.times.algorithm*(1-a)+r*a,e.times.gui=e.times.gui*(1-a)+h*a,e.element.steptime.html(r+" / "+h+" ("+Math.round(e.times.algorithm)+" / "+Math.round(e.times.gui)+")"),e.running?(t.begin(),window.requestAnimationFrame(e.nextStep),t.end()):e.clear.schedule&&e.cleanUp()},handlers:{mouseDown:!1,lastX:0,lastY:0,canvasMouseDown:function(t){var i=e.helpers.mousePosition(t);e.canvas.switchCell(i[0],i[1]),e.handlers.lastX=i[0],e.handlers.lastY=i[1],e.handlers.mouseDown=!0},canvasMouseUp:function(){e.handlers.mouseDown=!1},canvasMouseMove:function(t){if(e.handlers.mouseDown){var i=e.helpers.mousePosition(t);i[0]===e.handlers.lastX&&i[1]===e.handlers.lastY||(e.canvas.switchCell(i[0],i[1]),e.handlers.lastX=i[0],e.handlers.lastY=i[1])}},keyboard:function(t){var i=t;i||(i=window.event),67===i.keyCode?e.handlers.buttons.clear():82===i.keyCode?e.handlers.buttons.run():83===i.keyCode&&e.handlers.buttons.step()},buttons:{run:function(){e.element.hint.hide(),e.running=!e.running,e.running?(e.nextStep(),$("#buttonRun").value="Stop"):$("#buttonRun").value="Run"},step:function(){e.running||e.nextStep()},clear:function(){e.running?(e.clear.schedule=!0,e.running=!1,$("#buttonRun").value="Run"):e.cleanUp()},trail:function(){e.element.messages.layout.html(e.trail.current?"Trail is Off":"Trail is On"),e.trail.current=!e.trail.current,e.running?e.trail.schedule=!0:e.canvas.drawWorld()},export_:function(){var t,i,l="",n="",s="";for(t=0;t<e.listLife.actualState.length;t++){for(n+='{"'+e.listLife.actualState[t][0]+'":[',i=1;i<e.listLife.actualState[t].length;i++)n+=e.listLife.actualState[t][i]+",";n=n.substring(0,n.length-1)+"]},"}n=n.substring(0,n.length-1)+"",0!==n.length&&(l=window.location.href.indexOf("?")===-1?window.location.href:window.location.href.slice(0,window.location.href.indexOf("?")),s="?autoplay=0&trail="+(e.trail.current?"1":"0")+"&zoom="+(e.zoom.current+1)+"&s=["+n+"]",$("#exportUrlLink").href=s,$("#exportTinyUrlLink").href="http://tinyurl.com/api-create.php?url="+l+s,$("#exportUrl").style.display="inline")}}},canvas:{context:null,width:null,height:null,age:null,cellSize:null,cellSpace:null,init:function(){this.canvasElem=$("#canvas"),this.canvas=this.canvasElem[0],this.context=this.canvas.getContext("2d"),this.cellSize=e.zoom.schemes[e.zoom.current].cellSize,this.cellSpace=1,this.canvasElem.on("mousedown",e.handlers.canvasMouseDown),this.canvasElem.on("mousemove",e.handlers.canvasMouseMove),$(document).on("mouseup",e.handlers.canvasMouseUp),this.clearWorld()},clearWorld:function(){var t,i;for(this.age=[],t=0;t<e.columns;t++)for(this.age[t]=[],i=0;i<e.rows;i++)this.age[t][i]=0},drawWorld:function(){var t,i,l,n,s;for(this.width=this.height=0,this.width=this.width+this.cellSpace*e.columns+this.cellSize*e.columns,this.canvas.setAttribute("width",this.width),this.height=this.height+this.cellSpace*e.rows+this.cellSize*e.rows,this.canvas.setAttribute("height",this.height),this.context.fillRect(0,0,this.width,this.height),t=0;t<e.columns;t++)for(i=0;i<e.rows;i++)s=e.listLife.getCell(t,i),n=!!s,l=s?s[2]:"#000000",this.context.fillStyle=l,this.drawCell(t,i,l,n)},setNoGridOn:function(){this.cellSize=e.zoom.schemes[e.zoom.current].cellSize+1,this.cellSpace=0},setNoGridOff:function(){this.cellSize=e.zoom.schemes[e.zoom.current].cellSize,this.cellSpace=1},drawCell:function(t,i,l,n){n?this.age[t][i]>-1&&(this.context.fillStyle=l):e.trail.current&&this.age[t][i]<0?this.context.fillStyle="#ffffff":this.context.fillStyle="#000000",this.context.fillRect(this.cellSpace+this.cellSpace*t+this.cellSize*t,this.cellSpace+this.cellSpace*i+this.cellSize*i,this.cellSize,this.cellSize)},switchCell:function(t,i){if(e.listLife.isAlive(t,i))e.listLife.removeCell(t,i),this.changeCelltoDead(t,i,"#000000");else{var l=e.randomColor();e.listLife.addCell(t,i,l,e.listLife.actualState),this.changeCelltoAlive(t,i,l)}},keepCellAlive:function(t,i,l){t>=0&&t<e.columns&&i>=0&&i<e.rows&&(this.age[t][i]++,this.drawCell(t,i,l,!0))},changeCelltoAlive:function(t,i,l){t>=0&&t<e.columns&&i>=0&&i<e.rows&&(this.age[t][i]=1,this.drawCell(t,i,l,!0))},changeCelltoDead:function(t,i,l){t>=0&&t<e.columns&&i>=0&&i<e.rows&&(this.age[t][i]=-this.age[t][i],this.drawCell(t,i,l,!1))}},listLife:{actualState:[],redrawList:[],init:function(){this.actualState=[]},nextGeneration:function(){var t,i,l,n,s,a,o,r,h,c,u,d=0,f={},m=[];for(this.redrawList=[],n=0;n<this.actualState.length;n++)for(this.topPointer=1,this.bottomPointer=1,s=1;s<this.actualState[n].length;s++){for(t=this.actualState[n][s],i=this.actualState[n][0],u=[[t-1,i-1,1],[t,i-1,1],[t+1,i-1,1],[t-1,i,1],[t+1,i,1],[t-1,i+1,1],[t,i+1,1],[t+1,i+1,1]],c=this.getNeighboursFromAlive(t,i,n,u),a=0;a<8;a++)void 0!==u[a]&&(o=u[a][0]+","+u[a][1],void 0===f[o]?f[o]=1:f[o]++);0===c||1===c||c>3?this.redrawList.push([t,i,"#000000",0]):(l=e.randomColor(),this.addCell(t,i,l,m),d++,this.redrawList.push([t,i,l,2]))}for(o in f)3===f[o]&&(o=o.split(","),r=parseInt(o[0],10),h=parseInt(o[1],10),l=e.randomColor(),this.addCell(r,h,l,m),d++,this.redrawList.push([r,h,l,1]));return this.actualState=m,d},topPointer:1,middlePointer:1,bottomPointer:1,getNeighboursFromAlive:function(t,e,i,l){var n,s=0;if(void 0!==this.actualState[i-1]&&this.actualState[i-1][0]===e-1)for(n=this.topPointer;n<this.actualState[i-1].length&&!(this.actualState[i-1][n]>=t-1&&(this.actualState[i-1][n]===t-1&&(l[0]=void 0,this.topPointer=n+1,s++),this.actualState[i-1][n]===t&&(l[1]=void 0,this.topPointer=n,s++),this.actualState[i-1][n]===t+1&&(l[2]=void 0,1==n?this.topPointer=1:this.topPointer=n-1,s++),this.actualState[i-1][n]>t+1));n++);for(n=1;n<this.actualState[i].length&&!(this.actualState[i][n]>=t-1&&(this.actualState[i][n]===t-1&&(l[3]=void 0,s++),this.actualState[i][n]===t+1&&(l[4]=void 0,s++),this.actualState[i][n]>t+1));n++);if(void 0!==this.actualState[i+1]&&this.actualState[i+1][0]===e+1)for(n=this.bottomPointer;n<this.actualState[i+1].length&&!(this.actualState[i+1][n]>=t-1&&(this.actualState[i+1][n]===t-1&&(l[5]=void 0,this.bottomPointer=n+1,s++),this.actualState[i+1][n]===t&&(l[6]=void 0,this.bottomPointer=n,s++),this.actualState[i+1][n]===t+1&&(l[7]=void 0,1==n?this.bottomPointer=1:this.bottomPointer=n-1,s++),this.actualState[i+1][n]>t+1));n++);return s},getCell:function(t,e){var i,l;for(i=0;i<this.actualState.length;i++)if(this.actualState[i][0]===e)for(l=1;l<this.actualState[i].length;l++)if(this.actualState[i][l]===t)return this.actualState[i]},isAlive:function(t,e){return!!this.getCell(t,e)},cellColor:function(t,e){var i=this.getCell(t,e);return i?i[2]:"#000000"},removeCell:function(t,e,i){var l,n;for(l=0;l<i.length;l++)if(i[l][0]===e)if(2===i[l].length)i.splice(l,1);else for(n=1;n<i[l].length;n++)i[l][n]===t&&i[l].splice(n,1)},addCell:function(t,e,i,l){if(0===l.length)return void l.push([e,t,i]);var n,s,a,o,r,h=[];if(e<l[0][0]){for(h=[[e,t,i]],n=0;n<l.length;n++)h[n+1]=l[n];for(n=0;n<h.length;n++)l[n]=h[n]}else{if(e>l[l.length-1][0])return void(l[l.length]=[e,t,i]);for(s=0;s<l.length;s++){if(l[s][0]===e){for(o=[],r=!1,a=1;a<l[s].length;a++)!r&&t<l[s][a]&&(o.push(t),r=!r),o.push(l[s][a]);return o.unshift(e),r||o.push(t),void(l[s]=o)}if(e<l[s][0]){for(h=[],n=0;n<l.length;n++)n===s?(h[n]=[e,t,i],h[n+1]=l[n]):n<s?h[n]=l[n]:n>s&&(h[n+1]=l[n]);for(n=0;n<h.length;n++)l[n]=h[n];return}}}}},helpers:{urlParameters:null,random:function(t,e){return t<=e?t+Math.round(Math.random()*(e-t)):null},getUrlParameter:function(t){if(null===this.urlParameters){var e,i,l;for(this.urlParameters=[],i=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),l=0;l<i.length;l++)e=i[l].split("="),this.urlParameters.push(e[0]),this.urlParameters[e[0]]=e[1]}return this.urlParameters[t]},mousePosition:function(t){var i,l,n,s,a=0,o=0,r=0,h=0,c=e.zoom.schemes[e.zoom.current].cellSize+1;for(i=t,i||(i=window.event),i.pageX||i.pageY?(a=i.pageX,o=i.pageY):(i.clientX||i.clientY)&&(a=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,o=i.clientY+document.body.scrollTop+document.documentElement.scrollTop),s=i.target||i.srcElement;s.offsetParent;)h+=s.offsetLeft,r+=s.offsetTop,s=s.offsetParent;return s.pageTop=r,s.pageLeft=h,l=Math.ceil((a-s.pageLeft)/c-1),n=Math.ceil((o-s.pageTop)/c-1),[l,n]}}};$(window).on("load",function(){e.init()})}();