"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),GOL=function(){function t(){_classCallCheck(this,t),this.stats=new GOLStats,this.setup(),this.initialize()}return _createClass(t,[{key:"setup",value:function(){this.setupZoom(),this.setupVars(),this.setupElements(),this.setupStates()}},{key:"setupVars",value:function(){this.columns=0,this.rows=0,this.generation=0,this.running=!1,this.autoplay=!1,this.urlParameters=null}},{key:"setupZoom",value:function(){this.zoom=new GOLZoom,this.zoom.addZoomLevel(180,86,4),this.zoom.addZoomLevel(300,144,2),this.zoom.addZoomLevel(450,216,1)}},{key:"setupElements",value:function(){this.element={generation:$("#generation"),steptime:$("#steptime"),livecells:$("#livecells"),hint:$("#hint"),messages:{layout:$("#layoutMessages")},buttons:{run:$("#buttonRun"),step:$("#buttonStep"),clear:$("#buttonClear"),"export":$("#buttonExport"),trail:$("#buttonTrail")}}}},{key:"setupStates",value:function(){this.initialState='[{"39":[110]},{"40":[112]},{"41":[109,110,113,114,115]}]',this.times={algorithm:0,gui:0},this.clear={schedule:!1}}},{key:"loadCanvas",value:function(){this.helper=new GOLHelper,this.canvas=new GOLCanvas({game:this.game,columns:this.columns,rows:this.rows,zoom:this.zoom.schemes[this.zoom.current].cellSize}),this.canvas.clear()}},{key:"initialize",value:function(){this.game=new GOLGameState,this.loadConfig(),this.loadGameState(),this.loadCanvas(),this.registerEvents(),this.prepare()}},{key:"random",value:function(t,e){return t<=e?t+Math.round(Math.random()*(e-t)):null}},{key:"loadConfig",value:function(){this.autoplay="1"===this.getUrlParameter("autoplay")||this.autoplay;var t=parseInt(this.getUrlParameter("zoom"),10);(isNaN(t)||t<1||t>this.zoom.schemes.length)&&(t=1),this.zoom.current=t-1,this.rows=this.zoom.schemes[this.zoom.current].rows,this.columns=this.zoom.schemes[this.zoom.current].columns}},{key:"getUrlParameter",value:function(t){if(null===this.urlParameters){this.urlParameters=[];for(var e=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),i=0;i<e.length;i++){var n=e[i].split("=");this.urlParameters.push(n[0]),this.urlParameters[n[0]]=n[1]}}return this.urlParameters[t]}},{key:"loadGameState",value:function(){var t=this.getUrlParameter("s");if("random"===t)this.randomState();else{void 0==t&&(t=this.initialState);for(var e=$.parseJSON(decodeURI(t)),i=0;i<e.length;i++)for(var n in e[i])for(var s=0;s<e[i][n].length;s++)this.game.addCell(e[i][n][s],parseInt(n,10),this.game.currentState)}}},{key:"randomState",value:function(){for(var t=this.rows*this.columns*.12,e=0;e<t;e++)this.game.addCell(this.random(0,this.columns-1),this.random(0,this.rows-1),this.game.currentState);this.game.nextGeneration()}},{key:"cleanUp",value:function(){this.game.reset(),this.prepare()}},{key:"prepare",value:function(){this.generation=this.times.algorithm=this.times.gui=0,this.mouseDown=this.clear.schedule=!1,this.element.generation.html("0"),this.element.livecells.html("0"),this.element.steptime.html("0 / 0 (0 / 0)"),this.canvas.clear(),this.canvas.draw(this.game.currentState),this.autoplay&&(this.autoplay=!1,this.buttons.run())}},{key:"registerEvents",value:function(){$("body").on("keyup",this.keyboard),this.element.buttons.run.on("click",this.run),this.element.buttons.step.on("click",this.step),this.element.buttons.clear.on("click",this.clear),this.element.buttons["export"].on("click",this["export"])}},{key:"keyboard",value:function(t){var e=t;e||(e=window.event),67===e.keyCode?this.clear():82===e.keyCode?this.run():83===e.keyCode&&this.step()}},{key:"run",value:function(){this.element.hint.hide(),this.running=!this.running,this.running?(this.nextStep(),this.element.buttons.run.value="Stop"):this.element.buttons.run.value="Run"}},{key:"step",value:function(){this.running||this.nextStep()}},{key:"clear",value:function(){this.running?(this.clear.schedule=!0,this.running=!1,this.element.run.value="Run"):this.cleanUp()}},{key:"export",value:function(){for(var t="",e="",i="",n=0;n<this.game.currentState.length;n++){e+='{"'+this.game.currentState[n][0]+'":[';for(var s=1;s<this.game.currentState[n].length;s++)e+=this.game.currentState[n][s]+",";e=e.substring(0,e.length-1)+"]},"}e=e.substring(0,e.length-1)+"",0!==e.length&&(t=window.location.href.indexOf("?")===-1?window.location.href:window.location.href.slice(0,window.location.href.indexOf("?")),i="?autoplay=0&zoom="+(this.zoom.current+1)+"&s=["+e+"]",$("#exportUrlLink").href=i,$("#exportTinyUrlLink").href="http://tinyurl.com/api-create.php?url="+t+i,$("#exportUrl").style.display="inline")}},{key:"nextStep",value:function(){var t=new Date,e=this.game.nextGeneration();t=new Date-t;for(var i=new Date,n=0;n<this.game.nextState.length;n++){var s=this.game.nextState[n][0],a=this.game.nextState[n][1],r=this.game.nextState[n][2];1===this.game.nextState[n][2]?this.canvas.changeCelltoAlive(s,a,r):2===this.game.nextState[n][2]?this.canvas.keepCellAlive(s,a,r):this.canvas.changeCelltoDead(s,a,r)}i=new Date-i,this.canvas.draw(this.game.nextState),this.generation++,this.element.generation.innerHTML=this.generation,this.element.livecells.innerHTML=e;var o=1/this.generation;this.times.algorithm=this.times.algorithm*(1-o)+t*o,this.times.gui=this.times.gui*(1-o)+i*o,this.element.steptime.html(t+" / "+i+" ("+Math.round(this.times.algorithm)+" / "+Math.round(this.times.gui)+")"),this.running?(this.stats.begin(),window.requestAnimationFrame(this.nextStep),this.stats.end()):this.clear.schedule&&this.cleanUp()}}]),t}();