"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),GOL=function(){function t(){_classCallCheck(this,t),this.stats=new GOLStats,this.setup(),this.load()}return _createClass(t,[{key:"setup",value:function(){this.setupZoom(),this.setupVars(),this.setupElements(),this.setupStates()}},{key:"setupVars",value:function(){this.columns=0,this.rows=0,this.generation=0,this.running=!1,this.autoplay=!1,this.urlParameters=null}},{key:"setupZoom",value:function(){this.zoom=new GOLZoom,this.zoom.addZoomLevel(180,86,4),this.zoom.addZoomLevel(300,144,2),this.zoom.addZoomLevel(450,216,1)}},{key:"setupElements",value:function(){this.element={generation:$("#generation"),steptime:$("#steptime"),livecells:$("#livecells"),hint:$("#hint"),messages:{layout:$("#layoutMessages")},buttons:{runBtn:$("#buttonRun"),stepBtn:$("#buttonStep"),clearBtn:$("#buttonClear"),exportBtn:$("#buttonExport")}}}},{key:"setupStates",value:function(){this.initialState='[{"39":[110]},{"40":[112]},{"41":[109,110,113,114,115]}]',this.times={algorithm:0,gui:0},this.clear={schedule:!1}}},{key:"loadCanvas",value:function(){this.canvas=new GOLCanvas({game:this.game,columns:this.columns,rows:this.rows,zoom:this.zoom.schemes[this.zoom.current].cellSize}),this.canvas.clear()}},{key:"load",value:function(){this.game=new GOLGame,this.helper=new GOLHelper,this.loadConfig(),this.loadGameState(),this.loadCanvas(),this.registerEvents(),this.prepare()}},{key:"random",value:function(t,e){return t<=e?t+Math.round(Math.random()*(e-t)):null}},{key:"nextStep",value:function(){var t=new Date,e=this.game.nextGeneration();t=new Date-t;var n=new Date;n=new Date-n,this.canvas.draw(this.game.currentState),this.generation++,this.element.generation.innerHTML=this.generation,this.element.livecells.innerHTML=e;var i=1/this.generation;this.times.algorithm=this.times.algorithm*(1-i)+t*i,this.times.gui=this.times.gui*(1-i)+n*i,this.element.steptime.html(t+" / "+n+" ("+Math.round(this.times.algorithm)+" / "+Math.round(this.times.gui)+")"),this.running?(this.stats.begin(),window.requestAnimationFrame(this.nextStep),this.stats.end()):this.clear.schedule&&this.cleanUp()}},{key:"loadConfig",value:function(){this.autoplay="1"===this.getUrlParameter("autoplay")||this.autoplay;var t=parseInt(this.getUrlParameter("zoom"),10);(isNaN(t)||t<1||t>this.zoom.schemes.length)&&(t=1),this.zoom.current=t-1,this.rows=this.zoom.schemes[this.zoom.current].rows,this.columns=this.zoom.schemes[this.zoom.current].columns}},{key:"getUrlParameter",value:function(t){if(null===this.urlParameters){this.urlParameters=[];for(var e=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),n=0;n<e.length;n++){var i=e[n].split("=");this.urlParameters.push(i[0]),this.urlParameters[i[0]]=i[1]}}return this.urlParameters[t]}},{key:"loadGameState",value:function(){var t=this.getUrlParameter("s");if("random"===t)this.randomState();else{void 0==t&&(t=this.initialState);for(var e=$.parseJSON(decodeURI(t)),n=0;n<e.length;n++)for(var i in e[n])for(var s=0;s<e[n][i].length;s++)this.game.currentState.addCell(e[n][i][s],parseInt(i,10),{color:this.helper.randomColor()})}}},{key:"randomState",value:function(){for(var t=this.rows*this.columns*.12,e=0;e<t;e++)this.game.currentState.addCell(this.random(0,this.columns-1),this.random(0,this.rows-1),{color:this.helper.randomColor()})}},{key:"cleanUp",value:function(){this.game.reset(),this.prepare()}},{key:"prepare",value:function(){this.generation=this.times.algorithm=this.times.gui=0,this.mouseDown=this.clear.schedule=!1,this.element.generation.html("0"),this.element.livecells.html("0"),this.element.steptime.html("0 / 0 (0 / 0)"),this.canvas.clear(),this.canvas.draw(this.game.currentState),this.autoplay&&(this.autoplay=!1,this.buttons.runBtn.click())}},{key:"registerEvents",value:function(){$("body").on("keyup",this.keyboard),this.element.buttons.runBtn.on("click",this._run.bind(this)),this.element.buttons.stepBtn.on("click",this._step.bind(this)),this.element.buttons.clearBtn.on("click",this._clear.bind(this)),this.element.buttons.exportBtn.on("click",this._export.bind(this))}},{key:"keyboard",value:function(t){var e=t||window.event;67===e.keyCode?this._clear():82===e.keyCode?this._run():83===e.keyCode&&this._step()}},{key:"_run",value:function(){this.element.hint.hide(),this.running=!this.running,this.running?(this.nextStep(),this.element.buttons.run.value="Stop"):this.element.buttons.run.value="Run"}},{key:"_step",value:function(){this.running||this.nextStep()}},{key:"_clear",value:function(){this.running?(this.clear.schedule=!0,this.running=!1,this.element.run.value="Run"):this.cleanUp()}},{key:"_export",value:function(){for(var t="",e="",n="",i=0;i<this.game.currentState.length;i++){e+='{"'+this.game.currentState[i][0]+'":[';for(var s=1;s<this.game.currentState[i].length;s++)e+=this.game.currentState[i][s]+",";e=e.substring(0,e.length-1)+"]},"}e=e.substring(0,e.length-1)+"",0!==e.length&&(t=window.location.href.indexOf("?")===-1?window.location.href:window.location.href.slice(0,window.location.href.indexOf("?")),n="?autoplay=0&zoom="+(this.zoom.current+1)+"&s=["+e+"]",$("#exportUrlLink").href=n,$("#exportTinyUrlLink").href="http://tinyurl.com/api-create.php?url="+t+n,$("#exportUrl").style.display="inline")}}]),t}();